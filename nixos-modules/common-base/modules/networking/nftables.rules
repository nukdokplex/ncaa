#! /usr/bin/nft -f

table inet filter {
  chain input {
    type filter hook input priority filter; policy drop;

    counter jump pre_input_hook
    counter jump base_hook
    counter jump post_input_hook
    
    log prefix "Dropped input traffic: " counter drop
  }
  
  chain pre_input_hook { }
  chain post_input_hook { }

  chain output {
    type filter hook output priority filter; policy drop;

    counter jump pre_output_hook
    counter jump base_hook
    counter jump post_output_hook

    ct state new counter accept
    
    log prefix "Dropped output traffic: " counter drop
  }
  
  chain pre_output_hook { }
  chain post_output_hook { }

  chain forward {
    type filter hook forward priority filter; policy drop;

    counter jump pre_forward_hook
    counter jump base_hook
    counter jump post_forward_hook
    
    log prefix "Dropped forwarded traffic: " counter drop
  }
  
  chain pre_forward_hook { }
  chain post_forward_hook { }

  chain base_hook {
    counter jump pre_base_hook
    
    ct state vmap {
      established: accept,
      related: accept,
      new: continue,
      invalid: drop
    }

    # Allow loopback traffic
    iifname lo counter accept
    oifname lo counter accept

    counter jump post_base_hook
  }

  chain pre_base_hook { }
  chain post_base_hook { }
}

table inet nat {
  chain prerouting {
    type nat hook prerouting priority 0;
    counter jump prerouting_hook
  }

  chain postrouting {
    type nat hook postrouting priority 0;
    counter jump postrouting_hook
  }

  chain prerouting_hook { }
  chain postrouting_hook { }
}
